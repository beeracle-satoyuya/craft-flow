<!-- bb71b59a-953a-4b83-bb0a-40f715bb520b e6fd5f49-b41e-4b4b-ae6d-f9f1cda98d40 -->
# 銀行振込変換履歴機能の実装

## 実装内容

### 1. データベースマイグレーション作成

- **ファイル**: `database/migrations/YYYY_MM_DD_HHMMSS_create_bank_transfer_conversions_table.php`
- `bank_transfer_conversions`テーブルを作成
- カラム: `id`, `user_id` (foreign key), `original_filename`, `converted_filename`, `file_path`, `converted_at`, `created_at`, `updated_at`

### 2. モデル作成

- **ファイル**: `app/Models/BankTransferConversion.php`
- Eloquentモデルを作成
- `User`との`belongsTo`リレーションを定義
- ファイルパス管理用のアクセサ/メソッドを追加

### 3. 変換処理の修正

- **ファイル**: `resources/views/livewire/bank-transfers/index.blade.php`
- `$convertToZenkinFormat`関数内で履歴を保存
- ファイル保存先を`temp/`から`storage/app/private/bank-transfers/{user_id}/`に変更
- 元のExcelファイル名を`$this->excelFile->getClientOriginalName()`で取得
- `BankTransferConversion`モデルを使用してデータベースに保存

### 4. 履歴一覧画面の作成

- **ファイル**: `resources/views/livewire/bank-transfers/history.blade.php`
- Volt Functionalコンポーネントとして実装
- 変換履歴の一覧表示（変換日時、元ファイル名、変換後ファイル名）
- ページネーション対応（`with`を使用）
- 各履歴にダウンロードボタンを配置

### 5. ルーティング追加

- **ファイル**: `routes/web.php`
- 履歴一覧ページのルート: `Volt::route('dashboard/bank-transfers/history', 'bank-transfers.history')->name('bank-transfers.history')`
- 既存のダウンロードルートを拡張して履歴からのダウンロードに対応
- 履歴IDまたはファイル名でダウンロード可能にする

### 6. ダウンロード処理の修正

- **ファイル**: `routes/web.php`（ダウンロードルート部分）
- 既存の`temp/`からのダウンロードに加えて、履歴からのダウンロードに対応
- `BankTransferConversion`モデルからファイルパスを取得
- ダウンロード後はファイルを削除しない（履歴保持のため）

### 7. インデックスページへの履歴リンク追加

- **ファイル**: `resources/views/livewire/bank-transfers/index.blade.php`
- 履歴一覧ページへのリンクボタンを追加

## 実装の詳細

### ファイル保存パス

- 保存先: `storage/app/private/bank-transfers/{user_id}/{converted_filename}`
- ディスク: `local`（既存の実装と同様）

### 認可制御

- 全ユーザーの履歴を閲覧・ダウンロード可能（ユーザー要求通り）

### データベース設計

- `user_id`: 変換を実行したユーザー
- `original_filename`: アップロードしたExcelファイル名
- `converted_filename`: 変換後の全銀フォーマットファイル名
- `file_path`: 保存先の相対パス（`bank-transfers/{user_id}/{filename}`）
- `converted_at`: 変換実行日時

## 注意事項

- ファイルは永続保存されるため、ストレージ容量に注意
- 必要に応じて将来的に削除機能や自動削除を検討

### To-dos

- [ ] bank_transfer_conversionsテーブルのマイグレーションファイルを作成
- [ ] BankTransferConversionモデルを作成し、Userとのリレーションを定義
- [ ] 変換処理を修正して履歴を保存し、ファイルを永続保存ディレクトリに保存
- [ ] 履歴一覧画面（Volt Functional）を作成
- [ ] 履歴一覧とダウンロードのルーティングを追加・修正
- [ ] インデックスページに履歴一覧へのリンクを追加